<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>eludi websocket chat</title>
		<meta name="author" content="Gerald Franz"/>
		<meta name="keywords" content="eludi, chat"/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="viewport" content="user-scalable=no, width=device-width" />
		<style type="text/css">
body {
	font-family:sans-serif;
}
#paneForm {
	max-width:960px;
	margin:0 auto;
}
#paneForm input {
	box-sizing: border-box; -webkit-box-sizing: border-box; -moz-box-sizing: border-box;
	width:100%;
	margin: 0 0 0.2em 0;
}
#paneForm label {
	font-size:71%;
	font-weight:bold;
}
		</style>

		<script type="text/javascript" src="/static/EventSocket.js"></script>
		<script type="text/javascript">
cfg = {
	server:location.hostname + ':'+ location.port,
}

function App(cfg) {
	var self = this;

	this.connect = function() {
		var server = document.querySelector('#server').value;
		var channel = document.querySelector('#channel').value;
		var name = document.querySelector('#name').value;
		var transportLayer = 'ws';
	
		window.console && console.log('connect(',server,',',channel,',',name,')');

		if(this.socket) {
			this.socket.close();
			delete this.socket;
			this.socket = null;
		}
		if(!navigator.onLine) {
			this.status('no internet connection');
			setTimeout(function() { self.connect(); }, 4000);
			return;
		}
		this.status("connecting...");
		var socket = this.socket = new EventSocket(
			transportLayer+'://' + server +'/'+channel+'?name='+encodeURIComponent(name));
	
		socket.on('connect', function(data) {
			self.log(data.name+' connected. peers:'+JSON.stringify(data.peers));
		});
		socket.on('disconnect', function(data) {
			self.log(data.name+' disconnected.');
		});
		socket.on('chat', function(data) {
			self.log(data.name+' >> '+data.data);
		});
		socket.on('*', function(data, event) {
			console.error('unrecognized websocket event:'+event+' data:'+JSON.stringify(data));
		});
		socket.on('open', function(data) {
			document.querySelector('#btn_connect').style.display='none';
			document.querySelector('#btn_disconnect').style.display='';
			self.status("connected.");
		});
		socket.on('close', function(data) {
			var msg = "connection "+data.status+'.';
			if(data.code>1000)
				msg += ' code:'+data.code;
			if(data.reason)
				msg +=  " reason:"+data.reason;
			self.status(msg);
			delete self.socket;
			self.socket = null;
			document.querySelector('#btn_connect').style.display='';
			document.querySelector('#btn_disconnect').style.display='none';
		});
	}
	this.disconnect = function() {
		window.console && console.log('disconnect()');
		document.querySelector('#btn_connect').style.display='';
		document.querySelector('#btn_disconnect').style.display='none';

		if(!this.socket)
			return;
		if(this.socket.status=='open')
			this.socket.close();
		delete this.socket;
		this.socket = null;
		this.status('disconnected');
	}
	this.chat = function(msg) {
		if(!this.socket|| this.socket.status!='open')
			return false;
		console.log('>> '+msg);
		this.socket.emit('chat', msg);
		return true;
	}
	this.log = function(str) {
		console.log(str);
		document.querySelector('#output').innerHTML = str +'<br/>\n' + document.querySelector('#output').innerHTML;
	}
	this.status = function(str) {
		console.log('status',str);
		this.statusMsg = str;
		document.querySelector('#status').innerHTML = str;
	}

	this.socket = null;
	this.statusMsg = 'init';
}

ui = {
	onMsgKeyPress: function(event, value) {
		if (!event)
			event = window.event;
		var key=event.keyCode || event.which;
		if(key==13) { // enter
			if(app) app.chat(value);
			document.getElementById("input").value = '';
		}
	}
}

app = null;
window.onload = function() {
	document.getElementById('server').value = cfg.server;
	if(localStorage && localStorage.chat) {
		var settings = JSON.parse(localStorage.chat);
		for(var key in settings) {
			var v = settings[key];
			cfg[key] = v;
			document.getElementById(key).value = (typeof v == 'object') ? JSON.stringify(v) : v;
		}
	}
	app = new App(cfg);
}
window.onunload = function() {
	if(app)
		app.disconnect();
}

		</script>
	</head>

	<body>
		<div id="paneForm">
			<label for="server">server</label>
			<input type="text" id="server"/>
			<label for="channel">channel</label>
			<input type="text" id="channel"/>
			<label for="name">nick name</label>
			<input type="text" id="name"/>
			<div>
				<button id="btn_connect" onclick="app.connect()">connect</button>
				<button id="btn_disconnect" style="display:none;" onclick="app.disconnect()">disconnect</button>
				<span id="status"></span>
			</div>
			<label for="input">input</label>
			<input type="text" id="input" onchange="app.chat(this.value);" onkeypress="ui.onMsgKeyPress(event, this.value);" value=""/>
			<label for="output">output</label>
			<div id="output" style="border:1px silver solid;height:16em; overflow:scroll;"></div>
		</div>
	</body>
</html>

